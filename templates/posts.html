{% extends "base.html" %}

{% block title %}{{ blog_name }} | Posts{% endblock %}

{% block content %}
<section class="px-4 sm:px-6 text-center mx-auto max-w-2xl">
    <div id="posts-container" class="space-y-2 mx-auto">
        {% for post in posts %}
        <article class="post-item py-1 mx-auto">
            <div class="flex justify-between items-center text-sm">
                <a href="/post/{{ post.file|replace('.md', '') }}" class="link link-hover link-primary flex-1 truncate">
                    {{ post.title }}
                </a>
                <span class="text-secondary ml-4 text-xs opacity-70">{{ post.date }}</span>
            </div>
        </article>
        {% endfor %}
    </div>
    
    <div id="loading-indicator" class="hidden text-center py-4 text-xs">
        <span class="loading loading-spinner loading-sm"></span>
        <p class="text-secondary opacity-70 mt-2">Loading more posts...</p>
    </div>
    
    <div id="end-of-posts" class="hidden text-center py-4 text-xs">
        <p class="text-secondary opacity-70">You've reached the end of all posts.</p>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let currentOffset = parseInt("{{ posts|length }}");
    let isLoading = false;
    let hasMorePosts = true;
    
    function isNearBottom() {
        return window.innerHeight + window.scrollY >= document.body.offsetHeight - 500;
    }
    
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    async function loadMorePosts() {
        if (isLoading || !hasMorePosts) return;
        
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.classList.remove('hidden');
        isLoading = true;
        
        try {
            const response = await fetch(`/load_posts?offset=${currentOffset}&limit=5`);
            const data = await response.json();
            
            if (data.posts.length > 0) {
                const postsContainer = document.getElementById('posts-container');
                
                data.posts.forEach(post => {
                    const postElement = document.createElement('article');
                    postElement.className = 'post-item py-1 mx-auto';
                    
                    const postSlug = post.file ? post.file.replace('.md', '') : post.title.toLowerCase().replace(/\s+/g, '-');
                    
                    postElement.innerHTML = `
                        <div class="flex justify-between items-center text-sm">
                            <a href="/post/${postSlug}" class="link link-hover link-primary flex-1 truncate">
                                ${post.title}
                            </a>
                            <span class="text-secondary ml-4 text-xs opacity-70">${post.date}</span>
                        </div>
                    `;
                    postsContainer.appendChild(postElement);
                });
                
                currentOffset += data.posts.length;
            }
            
            if (data.posts.length < 5) {
                hasMorePosts = false;
                document.getElementById('end-of-posts').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error loading posts:', error);
        } finally {
            isLoading = false;
            loadingIndicator.classList.add('hidden');
        }
    }
    
    window.addEventListener('scroll', debounce(() => {
        if (isNearBottom()) {
            loadMorePosts();
        }
    }, 200));
</script>
{% endblock %}
